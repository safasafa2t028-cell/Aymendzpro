# api/webhook.py
from fastapi import FastAPI, Request, Response, HTTPException
import os
import httpx
import uvicorn

app = FastAPI()

# ضع هنا رابط السيرفر الداخلي الذي يستقبل الطلبات (السيرفر الذي لا يدعم HTTPS)
# يمكنك تغييره لاحقًا عبر متغير بيئة TARGET_SERVER_URL في Vercel
TARGET_SERVER_URL = os.getenv("TARGET_SERVER_URL", "http://noel.hidencloud.com:25151/webhook")

# optional: timeouts
HTTP_TIMEOUT = float(os.getenv("HTTP_TIMEOUT", "10.0"))

@app.get("/")
async def index():
    return {"status": "ok", "note": "Vercel proxy for Djezzy webhook"}

@app.api_route("/webhook", methods=["GET", "POST"])
async def proxy_webhook(request: Request):
    """
    Proxy requests from Facebook (HTTPS) to the internal HTTP server.
    GET (verification): forward query params and return upstream response.
    POST (messages): forward JSON payload and return upstream response.
    """
    async with httpx.AsyncClient(timeout=HTTP_TIMEOUT) as client:
        try:
            if request.method == "GET":
                # forward query parameters
                params = dict(request.query_params)
                upstream = await client.get(TARGET_SERVER_URL, params=params)
                return Response(content=upstream.content, status_code=upstream.status_code,
                                media_type=upstream.headers.get("content-type", "text/plain"))

            # POST: forward JSON body and headers (but do not forward hop-by-hop headers)
            body = await request.body()
            headers = {}
            # include content-type if present
            if "content-type" in request.headers:
                headers["Content-Type"] = request.headers.get("content-type")
            # Forward request to internal server
            upstream = await client.post(TARGET_SERVER_URL, content=body, headers=headers)
            return Response(content=upstream.content, status_code=upstream.status_code,
                            media_type=upstream.headers.get("content-type", "application/json"))
        except httpx.ConnectError:
            raise HTTPException(status_code=502, detail="❌ فشل الاتصال بالسيرفر الأصلي (TARGET_SERVER_URL)")
        except Exception as e:
            raise HTTPException(status_code=500, detail=f"❌ خطأ في الوسيط: {e}")
